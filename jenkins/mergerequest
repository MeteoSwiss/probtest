pipeline {
    agent {
        node {
            label 'daint'
        }
    }

    stages {
        stage('generate testdata') {
            steps {
                sh './jenkins/scripts/step_generate_testdata.sh'
            }
        }

        stage('run unittests amip') {
            steps {
                sh './jenkins/scripts/step_execute_unittest_amip.sh'
            }
        }

        stage('run unittests mch') {
            steps {
                sh './jenkins/scripts/step_execute_unittest_mch.sh'
            }
        }

        stage('test cli') {
            steps {
                sh'''
                source /project/g110/icon/probtest/conda/miniconda/bin/activate
                conda activate probtest
                pytest -v tests/cli/test_perturb_cli.py tests/cli/test_stats_cli.py tests/cli/test_tolerance_cli.py
                pytest -v tests/cli/test_cdo_table_cli.py
                '''
            }
        }
    }
}
